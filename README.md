# tg_fastapi_concepciya_Maks

Микросервис для приёма и обработки вебхуков от Telegram с передачей в абстрактный AI-агент

Сервис предназначен для приёма и обработки вебхуков от Telegram API с последующей передачей данных в асбтрактный (не берём конкретный, но считаем что работает с API) AI агент для обработки. 
Архитектура построена на принципе микросервисов с разделением ответственности между компонентами.

Концепция:
Telegram API отправляет POST-запрос на сервер при действии со стороны юзера (сообщение, команда и т.д.).
Используем VPS на котором разворачиваем nginx, FastAPI и БД на Докере (PostgreSQL, он же postgres
nginx принимает https запрос на порт 443, расшифровывает SSL-сертификат, перенаправляет запрос внутрь сервера на порт 8081
FastAPI обрабатывает запрос, валидирует данные, сохраняет лог в БД и асинхронно вызывает нашего абстрактного AI-агента
Postgres хранит историю вебхуков и результаты обработки AI
AI агент с API получает данные для обработки и возвращает результат

VPS используем для безопасности и удобства работы сервиса 24 на 7. nginx публичный интерфейс, порт 443. Fast API локально на VPS, порт 8081. Postgres тоже на VPS развёрнут на Docker, порт 5432.
Для удобства, раз Postgres на Docker, можно развернуть pgAdmin, но это опционально.

Обоснование выбора БД, очередей, протоколов и остального
БД PostgreSQL
- Позволяет работать с большим числом пользователей (например 1000) что для продакшена удобно, можно рассматривать как заявку на масштабирование
- Работа с индексами, поиск по времени, id, user_id, username (раз про работу с Telegram речь), поиск по статусам и т.д.
- Инструмент проверенный временем, с большим и активным сообществом и поддержкой. Для новичка много мануалов по запуску, для опытного пользователя возможность гибкого сбора статистики.
- Эффективный и гибкий способ хранение вебхуков, а это то что нам нужно (JSONB)

Очереди
В текущем варианте встроенный BackgroundTasks в FastAPI
- Для концепта берём нагрузку на 1000 запросов в час, с таким объёмом должен успешно справляться
- Не надо развёртывать что то дополнительно

Если придётся масштабироваться или число запросов вырастет, то можно будет сменить

Протоколы взаимодействия
- Telegram к nginx по протоколу https:443. Это безопасно, а также этого требует Tg как основное требование для работы
- nginx обращается к FastAPI по http:8081. В примере используется VPS, локальная сеть,SSL, удобно и безопасно.
- FastAPI к PostgreSQL по протоколу TCP:5432. Это естественный протокол для PostgreSQL.
- FastAPI обращается к нашему условному AI агенту по HTTPS Rest:443. Тоже стандарт для внешних API.


Картинка с концепцией в общих файлах
"2_Общая схема.png"

Код концепции в PoC.py 

.env переименован в .enx.txt для удобства просмотра, внутри ключи и url на которые ссылается PoC.py

пример БД для Piostgres в primer_BD.sql

Зависимости в requirements.txt

